localStorage.getItem("snapshot.data")||(document.location="/");import{downloadSpecializationsFromDB,openInfoPopup,closeInfoPopup}from"/js/functions.js";import{updateDoc,doc,getDoc,db,collection,setDoc,addDoc,getDocs,query,where}from"/js/global.js";const userInfo=JSON.parse(localStorage.getItem("snapshot.data")),changePersonalInformation=document.getElementById("personalInformation"),personalInformationForm=document.getElementById("personalInformationForm"),createSubjectForm=document.getElementById("createSubjectForm"),addSubjectForm=document.getElementById("addSubjectForm"),warningList=document.getElementById("warningsList"),addSubject=document.getElementById("addSubject"),createSubject=document.getElementById("createSubject"),personalTimetable=document.getElementById("personalTimetable"),infoPopup=document.getElementById("infoPopup"),infoPopupCloseButton=document.getElementById("infoPopupCloseButton"),createSubjectPopupCloseButton=document.getElementById("createSubjectPopupCloseButton"),addSubjectPopupCloseButton=document.getElementById("addSubjectPopupCloseButton");function changeUserInfoInDB(){const e=userInfo.uid;var t=document.querySelector("input[name='name']").value,o=document.querySelector("input[name='surname']").value,n=document.querySelector("input[name='dateBirthday']").value,u=document.querySelector("select[name='specialization']").value,a=document.querySelector("input[name='phone']").value,r=document.querySelector("input[name='imageUrl']").value;if(console.log(r),""!=r){var c=new Image;c.src=r,c.onload=function(){updateDoc(doc(db,"Students",e),{name:t,surname:o,dateBirthday:n,specialization_id:u,phone:a,photoUrl:r,fullInfo:!0}).then((()=>{userInfo.name=t,userInfo.surname=o,userInfo.dateBirthday=n,userInfo.specialization_id=u,userInfo.phone=a,userInfo.photoUrl=r,userInfo.fullInfo=!0,localStorage.setItem("snapshot.data",JSON.stringify(userInfo)),document.getElementById("userName").innerText=t+" "+o,document.getElementById("userPhotoUrl").src=userInfo.photoUrl,warningList.removeAttribute("disabled"),addSubject.removeAttribute("disabled"),createSubject.removeAttribute("disabled"),personalTimetable.removeAttribute("disabled"),closeInfoPopup()}))},c.onerror=function(){alert("Proszę zmienić link do zdjęcia. Lub usunąć go.")}}else updateDoc(doc(db,"Students",e),{name:t,surname:o,dateBirthday:n,specialization_id:u,phone:a,photoUrl:r,fullInfo:!0}).then((()=>{userInfo.name=t,userInfo.surname=o,userInfo.dateBirthday=n,userInfo.specialization_id=u,userInfo.phone=a,userInfo.photoUrl=r,userInfo.fullInfo=!0,localStorage.setItem("snapshot.data",JSON.stringify(userInfo)),document.getElementById("userName").innerText=t+" "+o,document.getElementById("userPhotoUrl").src=userInfo.photoUrl,warningList.removeAttribute("disabled"),addSubject.removeAttribute("disabled"),createSubject.removeAttribute("disabled"),personalTimetable.removeAttribute("disabled"),closeInfoPopup("infoPopup")}))}function downloadInformationFromLocalStorage(){document.getElementById("userName").innerText=userInfo.name+" "+userInfo.surname,userInfo.photoUrl&&(document.getElementById("userPhotoUrl").src=userInfo.photoUrl)}function putInfoInFormPersonalInformation_FullInfo(){downloadSpecializationsFromDB().then((e=>{showSpecializationsInList(e,"personalInfoSpecializations"),userInfo.specialization_id&&(document.querySelector("select[name='specialization']").value=userInfo.specialization_id)})).catch((e=>{console.log("Error with ",e)})),document.querySelector("input[name='name']").value=userInfo.name,document.querySelector("input[name='surname']").value=userInfo.surname,document.querySelector("input[name='dateBirthday']").value=userInfo.dateBirthday,document.querySelector("input[name='phone']").value=userInfo.phone,document.querySelector("input[name='email']").value=userInfo.email,document.querySelector("input[name='imageUrl']").value=userInfo.photoUrl}function putInfoInFormPersonalInformation_WithoutFullInfo(){downloadSpecializationsFromDB().then((e=>{showSpecializationsInList(e,"personalInfoSpecializations")})).catch((e=>{console.log("Error with ",e)})),document.querySelector("input[name='email']").value=userInfo.email,document.querySelector("input[name='imageUrl']").value=userInfo.photoUrl}function showSpecializationsInList(e,t){const o=document.getElementById(t);console.log(o),o.innerHTML="",e.forEach((e=>{const t=document.createElement("option");t.value=e.number_specialization,t.textContent=e.spec_name,o.appendChild(t)}))}function createSubjectInDB(){const e=userInfo.uid;var t=document.getElementById("createSubjectForm").querySelector("input[name='name']").value,o=document.getElementById("createSubjectForm").querySelector("input[name='subject_description']").value,n=document.getElementById("createSubjectForm").querySelector("input[name='kod']").value;addDoc(collection(db,"Subjects"),{subject_name:t,teacher_id:e,kod_przedmiotu:n,subject_desc:o}).then((()=>{closeInfoPopup("createSubjectPopup"),document.getElementById("createSubjectForm").querySelector("input[name='name']").value="",document.getElementById("createSubjectForm").querySelector("input[name='subject_description']").value="",document.getElementById("createSubjectForm").querySelector("input[name='kod']").value=""}))}function addSubjectFromDBToStudent(){var e=document.getElementById("addSubjectForm").querySelector("input[name='kod']").value;const t=query(collection(db,"Subjects"),where("kod_przedmiotu","==",e));getDocs(t).then((e=>{e.empty?alert("No subjects found with this code."):e.forEach((e=>{const t=query(collection(db,"Student-Subject"),where("student_id","==",userInfo.uid),where("subject_id","==",e.id));getDocs(t).then((t=>{t.empty?addDoc(collection(db,"Student-Subject"),{student_id:userInfo.uid,subject_id:e.id}).then((()=>{closeInfoPopup("addSubjectPopup"),document.getElementById("addSubjectForm").querySelector("input[name='kod']").value=""})):alert("You have already added this subject.")}))}))})).catch((e=>{alert("Error fetching documents: ",e)}))}getDoc(doc(db,"Teachers",userInfo.uid)).then((e=>{console.log("snapshot.data - ",e.data()),e.data()?(localStorage.setItem("teacher","true"),createSubject.setAttribute("style","display:block"),addSubject.setAttribute("style","display:none")):getDoc(doc(db,"Rektors",userInfo.uid)).then((e=>{e.data()?(localStorage.setItem("rektor","true"),createSubject.setAttribute("style","display:block"),addSubject.setAttribute("style","display:none")):(createSubject.setAttribute("style","display:none"),addSubject.setAttribute("style","display:block"),localStorage.setItem("student","true"))}))})).catch((e=>{console.log(e)})),userInfo.fullInfo?(document.querySelector("select[name='specialization']").setAttribute("disabled",""),downloadInformationFromLocalStorage(),changePersonalInformation.removeAttribute("disabled"),warningList.removeAttribute("disabled"),addSubject.removeAttribute("disabled"),createSubject.removeAttribute("disabled"),personalTimetable.removeAttribute("disabled")):changePersonalInformation.removeAttribute("disabled"),changePersonalInformation.addEventListener("click",(()=>{openInfoPopup("infoPopup"),userInfo.fullInfo&&putInfoInFormPersonalInformation_FullInfo(),userInfo.fullInfo||putInfoInFormPersonalInformation_WithoutFullInfo()})),personalInformationForm.addEventListener("submit",(e=>{e.preventDefault(),changeUserInfoInDB()})),infoPopupCloseButton.addEventListener("click",(()=>{closeInfoPopup("infoPopup")})),warningList.addEventListener("click",(()=>{document.location="/announcement.html"})),addSubject.addEventListener("click",(()=>{openInfoPopup("addSubjectPopup")})),addSubjectForm.addEventListener("submit",(e=>{e.preventDefault(),addSubjectFromDBToStudent()})),addSubjectPopupCloseButton.addEventListener("click",(()=>{closeInfoPopup("addSubjectPopup")})),createSubject.addEventListener("click",(()=>{openInfoPopup("createSubjectPopup")})),createSubjectForm.addEventListener("submit",(e=>{e.preventDefault(),createSubjectInDB()})),createSubjectPopupCloseButton.addEventListener("click",(()=>{closeInfoPopup("createSubjectPopup")}));